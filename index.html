<html>
  <head>
    <title>note4u</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script type="text/javascript">
      var num_text = 0;
      var num_picture = 0;
      var num_video = 0;
      var num_canvas = 0;

      var current_canvas = 0;

      var time_since_last_touch = -1;

      var eraser_state = false;


      function init(){
	  document.getElementById("editor").style.display = "none";
	  document.getElementById("editor_buttons").style.display = "none";
      }
      
      function add(type){
	  var elem;
	  var id;
	  
	  switch(type){
	  case 'text':
	      elem = document.createElement("textarea"); 
	      elem.setAttribute("placeholder","Enter text here");
	      elem.setAttribute("id", "text_".concat(num_text++));
	      break;
	  case 'picture':
	      elem = document.createElement("input");
	      elem.setAttribute("id", "picture_".concat(num_picture++));
	      elem.setAttribute("type", "file");
	      elem.setAttribute("accept", "image/*");
	      elem.setAttribute("capture", "camera");
	      elem.setAttribute("onchange", "change_image(this)");
	      break;
	  case 'video':
	      elem = document.createElement("input"); 
	      elem.setAttribute(id, "video_".concat(num_video++));
	      elem.setAttribute("type", "file");
	      elem.setAttribute("accept", "video/*");
	      elem.setAttribute("capture", "camera");
	      elem.setAttribute("onchange", "change_video(this)");
	      break
	  case 'canvas':
	      elem = document.createElement("img");
	      current_canvas = num_canvas;
	      elem.setAttribute("id", "canvas_"+(num_canvas++));
	      
	      elem.addEventListener("dblclick", open_canvas);
	      elem.addEventListener("touchstart", test_double_click);
	      document.getElementById("content").style.display = "none";
	      document.getElementById("content_buttons").style.display = "none";

	      document.getElementById("editor").style.display = "inline";
	      document.getElementById("editor_buttons").style.display = "inline";
	      break;
	  }
 	  
	  var p = document.createElement("p");
	  p.appendChild(elem);
	  
	  var div = document.getElementById("notes");
	  div.appendChild(p);
      }

      function change_image(e){
	  var pic_url = URL.createObjectURL(e.files[0]);
	  var id_of_img_tag = e.id.concat("_img");
	  var elem = document.getElementById(id_of_img_tag);
	  if(!elem){
	      elem = document.createElement("img");
	      elem.setAttribute("id", id_of_img_tag);
	      elem.setAttribute("alt", "image");
	      insertAfter(elem, e);
	  }
	  elem.setAttribute("src", pic_url);
      }

      function change_video(e){
	  var vid_url = URL.createObjectURL(e.files[0]);
	  var id_of_vid_tag = e.id.concat("_vid");
	  var elem = document.getElementById(id_of_vid_tag);
	  if(!elem){
	      elem = document.createElement("video");
	      elem.setAttribute("id", id_of_vid_tag);
	      elem.setAttribute("controls","");
	      insertAfter(elem, e);
	  }
	  elem.setAttribute("src", vid_url);
      }

      function insertAfter(el, referenceNode){
	  referenceNode.parentNode.insertBefore(el, referenceNode.nextSibling);
      }

     
      function test_double_click(event){
	  var d = new Date;
	  var millis = d.getTime();
	  if(millis-time_since_last_touch<500){
	      event.preventDefault();
	      open_canvas(event);
	  }
	  else{
	      time_since_last_touch = millis;
	  }
      }
      

      function open_canvas(event){
	  var i = event.target;
	  var num = i.id.split("_")[1];
	  
	  document.getElementById("content").style.display = "none";
	  document.getElementById("content_buttons").style.display = "none";
	  
	  document.getElementById("editor").style.display = "inline";
	  document.getElementById("editor_buttons").style.display = "inline";

	  current_canvas = num;
	  var image = new Image;
	  image.src = i.src;
	  document.getElementById("ed_canvas").getContext('2d').drawImage(image,0,0);
	  
	  
      }

      function close_canvas(){
	  var c = document.getElementById("ed_canvas");
	  var dataURL = c.toDataURL();
	  document.getElementById("canvas_"+current_canvas).setAttribute("src",dataURL);

	  document.getElementById("content").style.display = "inline";
	  document.getElementById("content_buttons").style.display = "inline";
	  
	  document.getElementById("editor").style.display = "none";
	  document.getElementById("editor_buttons").style.display = "none";

	  c.getContext('2d').clearRect(0, 0, c.width, c.height);
      }

      function download_data(event){

      }

      var cur_drawing_ctx = -1;

      function start_path(event){
	  if(event.type=='touchstart'){
	      event.preventDefault();
	  }
	  cur_drawing_ctx = event.target.getContext("2d");
	  cur_drawing_ctx.beginPath();
	  if(event.type=='touchstart'){
	      cur_drawing_ctx.moveTo(event.layerX, event.layerY);
	  }
	  else{
	      cur_drawing_ctx.moveTo(event.layerX-event.target.offsetLeft, event.layerY-event.target.offsetTop);
	  }
      }

      function draw_to_new_point(event){
	  if(event.type=='touchmove'){
	      event.preventDefault();
	  }
	  if(cur_drawing_ctx!=-1){
	      if(event.type=='touchmove'){
		  cur_drawing_ctx.lineTo(event.layerX, event.layerY);
	      }
	      else{
		  cur_drawing_ctx.lineTo(event.layerX-event.target.offsetLeft, event.layerY-event.target.offsetTop);
	      }
	      cur_drawing_ctx.stroke();
	  }
      }
      
      function end_path(event){
	  cur_drawing_ctx.stroke();
	  cur_drawing_ctx = -1;
      }

      function select_color(){
	  var ctx = document.getElementById("ed_canvas").getContext('2d');
	  var color = document.getElementById("color_picker").value;
	  ctx.strokeStyle = color;
      }

      function select_linewidth(){
	  var ctx = document.getElementById("ed_canvas").getContext('2d');
	  var lw = document.getElementById("linewidth_slider").value;
	  ctx.lineWidth = lw;
      }

      function eraser(){
	  var btn = document.getElementById("eraser_btn");
	  if(!eraser_state){
	      btn.setAttribute("class","pressed");
	      eraser_state = true;
	  }
	  else{
	      btn.setAttribute("class", "bar");
	      eraser_state = false;
	  }
      }

    </script>
</head>
<body onload="init()">
  <header>
    <h1>Note4u</h1>
  </header>
  <section>
    <article>
      <div id="content">
	<p>This website lets you create notes. There are different kinds of note:
	  <ul>
	    <li><b>Canvas note</b>: allows you to freely draw something</li>
	    <li><b>Picture note</b>: allows you to take a picture</li>
	    <li><b>Video note</b>: allows you to record a video</li>
	    <li><b>Text note</b>: allows you to create a textual note</li>
	  </ul>
	  You can add them via click on the buttons below, just try it. After you're done, you can download them.</p>
	<p id="debug">Debug</p>
	<div id="notes">
	</div>
      </div>
      <div id="editor">
	<canvas id="ed_canvas"></canvas>
	<script>
	  var c = document.getElementById("ed_canvas");
	  c.width = window.innerWidth*0.95;
	  c.height = window.innerHeight*0.8;

	  c.addEventListener("mousedown", start_path);
	  c.addEventListener("mousemove", draw_to_new_point);
	  c.addEventListener("mouseup", end_path);
	  
	  c.addEventListener("touchstart", start_path);
	  c.addEventListener("touchmove", draw_to_new_point);
	  c.addEventListener("touchend", end_path);

	  c.getContext('2d').lineWidth = 5;
	</script>
      </div>
      <footer>
	<div id="content_buttons">
	  <button type="button" class="create" onclick="add('canvas')"><span width="100%" height="100%"><img src="./icon/canvas.png" width="100%"/></span> </button>
	  <button type="button" class="create" onclick="add('picture')"><span width="100%" height="100%"><img src="./icon/picture.png" width="100%"/></span></button>
	  <button type="button" class="create" onclick="add('video')"><span width="100%" height="100%"><img src="./icon/video.png" width="100%"/></span></button>
	  <button type="button" class="create" onclick="add('text')"><img src="./icon/text.png" width="100%"/></button>
	  <button type="button" class="create" onclick="download_data()"><img src="./icon/save.png" width="100%"/></button>
	</div>
	<div id="editor_buttons">
	  <label>Color:</label>
	  <input type="color" id="color_picker" onchange="select_color()">
	  <label>Linewidth:</label>
	  <input type="range" min="1" max="30" value="5" id="linewidth_slider" onchange="select_linewidth()">
	  <button id="eraser_btn" type="button" onclick="eraser()">Eraser</button>
	  <button onclick="close_canvas()" type="button">Save & back</button>
	</div>
    </footer>
    </article>
  </section>
</body>

</html>
